<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Hyper Space</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;500;700;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        :root { --bg-dark: #050508; --glass: rgba(255, 255, 255, 0.05); --border: rgba(255, 255, 255, 0.1); --primary: #4e54c8; --accent: #00f2ff; --text: #ffffff; }
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Outfit', sans-serif; user-select: none; }
        body { background-color: var(--bg-dark); color: var(--text); overflow-x: hidden; }
        #canvas-bg { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: -1; opacity: 0.4; }

        /* Header */
        .header { display: flex; justify-content: space-between; align-items: center; padding: 15px 25px; background: rgba(5, 5, 8, 0.95); backdrop-filter: blur(15px); border-bottom: 1px solid var(--border); position: fixed; top: 0; width: 100%; z-index: 100; }
        .user-info { display: flex; align-items: center; gap: 15px; }
        .xp-display { background: rgba(0, 242, 255, 0.05); color: var(--accent); padding: 6px 16px; border-radius: 50px; font-weight: 700; border: 1px solid rgba(0, 242, 255, 0.3); font-size: 13px; display: flex; align-items: center; gap: 8px; }

        /* Main Menu */
        .main-content { margin-top: 90px; padding: 20px; display: flex; flex-direction: column; align-items: center; gap: 30px; min-height: 80vh; justify-content: center; }
        .game-card-large { background: linear-gradient(180deg, rgba(10,10,20,0.8) 0%, rgba(78, 84, 200, 0.1) 100%); border: 1px solid var(--border); padding: 50px; border-radius: 30px; text-align: center; transition: 0.4s; cursor: pointer; width: 100%; max-width: 500px; backdrop-filter: blur(10px); box-shadow: 0 20px 50px rgba(0,0,0,0.3); }
        .game-icon-large { font-size: 80px; color: var(--accent); margin-bottom: 20px; filter: drop-shadow(0 0 20px rgba(0, 242, 255, 0.4)); animation: float 3s ease-in-out infinite; }
        .play-btn-large { margin-top: 30px; padding: 15px 60px; background: var(--primary); color: white; border: none; border-radius: 50px; font-weight: 900; font-size: 18px; cursor: pointer; transition: 0.3s; letter-spacing: 1px; box-shadow: 0 10px 30px rgba(78, 84, 200, 0.4); }

        /* Game Screen */
        .game-modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #000; z-index: 2000; display: none; flex-direction: column; }
        
        /* HUD - XP Only */
        .game-hud { position: absolute; top: 20px; left: 20px; color: white; font-family: 'Outfit', sans-serif; z-index: 2002; pointer-events: none; }
        .hud-item { margin-bottom: 5px; font-weight: 800; font-size: 24px; text-shadow: 0 2px 10px rgba(0,0,0,0.8); display: flex; align-items: center; gap: 10px;}
        
        .effects-hud { position: absolute; bottom: 30px; right: 20px; display: flex; flex-direction: column; gap: 10px; align-items: flex-end; z-index: 2002; pointer-events: none; }
        .effect-badge { background: rgba(0,0,0,0.8); border: 1px solid rgba(255,255,255,0.1); padding: 6px 12px; border-radius: 30px; color: white; font-weight: bold; font-size: 12px; display: flex; align-items: center; gap: 10px; backdrop-filter: blur(5px); }
        
        .close-game { position: absolute; top: 20px; right: 20px; background: rgba(255,255,255,0.1); color: white; border: 1px solid rgba(255,255,255,0.2); padding: 8px 20px; border-radius: 50px; cursor: pointer; z-index: 2002; font-weight: 600; backdrop-filter: blur(5px); }
        canvas#gameCanvas { width: 100%; height: 100%; display: block; touch-action: none; cursor: none; }

        /* Overlays */
        #startOverlay, #gameOverScreen { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(5, 5, 8, 0.9); z-index: 2003; display: flex; flex-direction: column; justify-content: center; align-items: center; backdrop-filter: blur(15px); text-align: center; }
        .game-title-text { font-size: 40px; font-weight: 900; letter-spacing: 3px; color: white; margin-bottom: 10px; text-shadow: 0 0 30px var(--primary); }
        .score-big { font-size: 60px; font-weight: 900; color: var(--accent); margin: 10px 0; text-shadow: 0 0 20px rgba(0, 242, 255, 0.5); }
        .action-btn { padding: 16px 50px; font-size: 16px; border-radius: 50px; border: none; cursor: pointer; margin: 10px; font-weight: 700; transition: 0.3s; min-width: 220px; text-transform: uppercase; letter-spacing: 1px; }
        .btn-claim { background: linear-gradient(135deg, #00c853, #009624); color: white; box-shadow: 0 10px 30px rgba(0, 200, 83, 0.3); }
        .btn-retry { background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.2); color: white; }
        .saving-overlay { position: fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.9); z-index: 3000; display: none; justify-content: center; align-items: center; flex-direction: column; color: white; font-weight: bold; }
        .spinner { width: 50px; height: 50px; border: 5px solid rgba(255,255,255,0.1); border-top-color: var(--accent); border-radius: 50%; animation: spin 1s infinite linear; margin-bottom: 20px; }
        
        @keyframes float { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-15px); } }
        @keyframes spin { 100% { transform: rotate(360deg); } }
    </style>
</head>
<body>

    <canvas id="canvas-bg"></canvas>

    <div id="saveLoader" class="saving-overlay"><div class="spinner"></div><div id="saveText">SYNCING DATA...</div></div>

    <div class="header">
        <div style="font-size: 22px; font-weight: 800; color: white; letter-spacing: 1px;">SKY <span style="color:var(--accent)">ARCADE</span></div>
        <div class="user-info">
            <div class="xp-display"><i class="fas fa-bolt"></i> <span id="headerXp">...</span> <span>XP</span></div>
        </div>
    </div>

    <div class="main-content">
        <div class="game-card-large" onclick="startGame()">
            <div class="game-icon-large"><i class="fas fa-rocket"></i></div>
            <h1 style="margin-bottom:10px;">Hyper Space</h1>
            <p style="color:#8b9bb4; font-size:16px;">Navigate. Survive. Collect XP.</p>
            <div style="margin-top:25px; font-size:14px; color:rgba(255,255,255,0.5); border-top:1px solid rgba(255,255,255,0.1); padding-top:15px;">YOUR BEST XP<br><span id="rocketHigh" style="color:var(--accent); font-size:24px; font-weight:bold;">0</span></div>
            <button class="play-btn-large">LAUNCH MISSION</button>
        </div>
        <button onclick="window.location.href='menu.html'" style="margin-top:20px; background:transparent; border:none; color:var(--text-muted); font-size:14px; cursor:pointer; opacity:0.7;">Back to Dashboard</button>
    </div>

    <div class="game-modal" id="gameModal">
        <div class="game-hud">
            <div class="hud-item"><i class="fas fa-bolt" style="color:var(--accent);"></i> <span id="gameXP">0</span></div>
        </div>
        <div class="effects-hud" id="effectsHud"></div>
        <button class="close-game" onclick="exitGame()">EXIT</button>
        <canvas id="gameCanvas"></canvas>

        <div id="startOverlay" onclick="initGameLogic()">
            <div class="game-title-text">READY?</div>
            <div style="font-size:16px; color:#aaa;">Tap to Engage Thrusters</div>
        </div>

        <div id="gameOverScreen" style="display:none;">
            <h1 class="game-title-text" style="color:#ff4444;">WRECKED</h1>
            <div style="display:flex; flex-direction: column; align-items: center; margin:20px 0;">
                <div style="font-size:14px; color:#aaa; text-transform:uppercase;">XP Gained</div>
                <div class="score-big" id="finalXP" style="color:var(--accent);">0</div>
            </div>
            <div>
                <button class="action-btn btn-claim" onclick="saveData()">CLAIM XP</button>
                <button class="action-btn btn-retry" onclick="resetGame()">RETRY</button>
            </div>
        </div>
    </div>

    <script type="module" src="./system.js"></script>

    <script type="module">
        import { supabase } from './supabase.js';

        // Global Vars
        let currentUser=null, gameActive=false, gameLoopId=null, currentRunXP=0;
        let gamePaused = true;
        let localBest = 0;
        
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        let width, height;

        function resizeGame() { width = canvas.width = window.innerWidth; height = canvas.height = window.innerHeight; }
        window.addEventListener('resize', resizeGame);

        async function initPage() {
            document.querySelector('.support-float').style.display = 'none'; // Hide support btn

            const { data: { session } } = await supabase.auth.getSession();
            if (!session) { window.location.replace("login.html"); return; }
            currentUser = session.user;
            
            const { data: profile } = await supabase.from('users').select('xp').eq('id', currentUser.id).single();
            const serverBest = profile?.xp || 0;
            document.getElementById('headerXp').innerText = serverBest.toLocaleString();
            
            const unsaved = parseInt(localStorage.getItem('rocket_high') || '0');
            localBest = Math.max(serverBest, unsaved); // Display highest ever
            document.getElementById('rocketHigh').innerText = localBest;
            
            resizeGame();
        }
        initPage();

        window.startGame = function() {
            document.getElementById('gameModal').style.display = 'flex';
            document.getElementById('startOverlay').style.display = 'flex';
            document.getElementById('gameOverScreen').style.display = 'none';
            resizeGame();
            // Start drawing immediately (background mode)
            startRocketGame();
        };

        window.initGameLogic = function() {
            document.getElementById('startOverlay').style.display = 'none';
            gameActive = true; 
            gamePaused = false; // Unpause physics
            currentRunXP = 0;
        };

        window.exitGame = function() {
            gameActive = false; cancelAnimationFrame(gameLoopId);
            location.reload();
        };

        window.saveData = async function() {
            if (currentRunXP <= 0) { location.reload(); return; }
            const loader = document.getElementById('saveLoader'); loader.style.display = 'flex';
            try {
                let { data: profile } = await supabase.from('users').select('xp').eq('id', currentUser.id).single();
                let newTotal = Math.max((profile?.xp || 0), currentRunXP); // Ø¥Ø°Ø§ ÙƒÙ†Øª ØªØ±ÙŠØ¯ Ø­ÙØ¸ "Ø£Ø¹Ù„Ù‰ Ø±Ù‚Ù…" ÙÙ‚Ø·
                // Ø£Ùˆ Ø¥Ø°Ø§ ÙƒÙ†Øª ØªØ±ÙŠØ¯ Ø¬Ù…Ø¹ Ø§Ù„Ù†Ù‚Ø§Ø· (ØªØ±Ø§ÙƒÙ…ÙŠ): let newTotal = (profile?.xp || 0) + currentRunXP; 
                // Ø³Ø£ÙØªØ±Ø¶ Ø£Ù†Ùƒ ØªØ±ÙŠØ¯ "ØªØ¬Ù…ÙŠØ¹" Ø§Ù„Ù€ XP ÙƒØ¹Ù…Ù„Ø©ØŒ Ù„Ø£Ù†Ùƒ Ù‚Ù„Øª "Collect XP".
                // Ø¥Ø°Ø§ ÙƒÙ†Øª ØªØ±ÙŠØ¯ "Ø£Ø¹Ù„Ù‰ Ù†ØªÙŠØ¬Ø©" ÙÙ‚Ø·ØŒ Ø£Ø®Ø¨Ø±Ù†ÙŠ Ù„Ø£Ø¹Ø¯Ù„Ù‡Ø§. Ø³Ø£Ø¬Ø¹Ù„Ù‡Ø§ ØªØ¬Ù…ÙŠØ¹ÙŠØ© Ø§Ù„Ø¢Ù† Ù„Ø£Ù†Ù‡Ø§ Ù…Ù…ØªØ¹Ø© Ø£ÙƒØ«Ø±.
                
                // ØªØ­Ø¯ÙŠØ«: Ø£Ù†Øª Ø·Ù„Ø¨Øª High Score ÙÙŠ Ø§Ù„Ø±Ø¯ Ø§Ù„Ø³Ø§Ø¨Ù‚. Ø³Ø£Ø¬Ø¹Ù„Ù‡Ø§ "Ø£Ø¹Ù„Ù‰ Ù†ØªÙŠØ¬Ø©" (High Score Mode)
                if (currentRunXP > (profile?.xp || 0)) {
                     await supabase.from('users').update({ xp: currentRunXP }).eq('id', currentUser.id);
                }
                
                if (currentRunXP > localBest) localStorage.setItem('rocket_high', currentRunXP);
                window.location.href = "menu.html";
            } catch (err) { location.reload(); }
        };

        window.resetGame = function() {
            // Check High Score Locally
            if(currentRunXP > localBest) { localBest = currentRunXP; localStorage.setItem('rocket_high', currentRunXP); }
            document.getElementById('gameOverScreen').style.display = 'none';
            // Reset Game State
            gameActive = true; gamePaused = false; currentRunXP = 0;
            startRocketGame(); // Restart engine
        };

        function gameOver() {
            gamePaused = true; // Stop physics
            document.getElementById('finalXP').innerText = Math.floor(currentRunXP);
            document.getElementById('gameOverScreen').style.display = 'flex';
        }

        // ==========================================
        // ðŸš€ ROCKET ENGINE (VISUALS READY BEFORE START)
        // ==========================================
        let rocket = { x: 0, y: 0 };
        let obstacles = [], items = [], stars = [], bullets = [], particles = [];
        let gameTime = 0;
        let buffs = { shield: {active:false, timer:0, max:600, color:'#00f2ff'}, ammo: {active:false, timer:0, max:900, color:'#ff3d00'}, x2: {active:false, timer:0, max:900, color:'#e040fb'} };
        let speedFactor = 1, mouse = { x: width/2, y: height/2 };

        canvas.addEventListener('mousemove', e => { const r = canvas.getBoundingClientRect(); mouse.x = e.clientX - r.left; mouse.y = e.clientY - r.top; });
        canvas.addEventListener('touchmove', e => { e.preventDefault(); const r = canvas.getBoundingClientRect(); mouse.x = e.touches[0].clientX - r.left; mouse.y = e.touches[0].clientY - r.top; }, {passive: false});

        function startRocketGame() {
            rocket.x = width/2; rocket.y = height - 150; mouse.x = width/2; mouse.y = height - 150;
            obstacles = []; items = []; stars = []; bullets = []; particles = [];
            Object.keys(buffs).forEach(k => { buffs[k].active = false; });
            document.getElementById('effectsHud').innerHTML = '';
            
            for(let i=0; i<60; i++) stars.push({x: Math.random()*width, y: Math.random()*height, z: Math.random()*2 + 0.5});
            gameTime = 0; speedFactor = 1; 
            gamePaused = true; // Paused initially (Draws but doesn't move)

            if(gameLoopId) cancelAnimationFrame(gameLoopId);
            function loop() {
                if(!gamePaused) updateRocket(); // Only update physics if playing
                drawRocketGame(); // Always draw (so we see rocket behind overlay)
                gameLoopId = requestAnimationFrame(loop);
            }
            loop();
        }

        function updateRocket() {
            gameTime++;
            if (gameTime % 400 === 0) speedFactor += 0.1;
            const currentSpeed = (3.0 + (gameTime/800)) * speedFactor;
            rocket.x += (mouse.x - rocket.x) * 0.15; rocket.y += (mouse.y - rocket.y) * 0.15;

            // Spawn Rocks
            if (gameTime % Math.max(25, Math.floor(70/speedFactor)) === 0) {
                const size = Math.random() * 30 + 20;
                const hp = size > 40 ? 2 : 1;
                const xPos = Math.random() * (width - size);
                let safe = true;
                obstacles.forEach(o => { if (Math.hypot(o.x - xPos, o.y - (-50)) < 80) safe = false; });
                if (safe) {
                    const verts = []; const sides = Math.floor(Math.random()*3)+5;
                    for(let i=0;i<sides;i++) { const a = (i/sides)*Math.PI*2; const r = size*(0.7+Math.random()*0.3); verts.push({x:Math.cos(a)*r, y:Math.sin(a)*r}); }
                    obstacles.push({ x: xPos, y: -50, size: size, speed: currentSpeed, verts: verts, rot: 0, rotS: (Math.random()-0.5)*0.1, hp:hp });
                }
            }
            // Spawn Items
            if (gameTime % 200 === 0) {
                const r = Math.random(); let type = 'fuel'; 
                if(r < 0.05) type = 'shield'; else if(r < 0.12) type = 'x2'; else if(r < 0.25) type = 'ammo'; else if(r < 0.35) type = 'gem';
                items.push({ x: Math.random()*(width-40), y: -50, type: type, speed: currentSpeed });
            }
            // Auto Fire
            if (buffs.ammo.active && gameTime % 15 === 0) bullets.push({x: rocket.x, y: rocket.y - 30});

            // Logic Loops (Bullets, Rocks, Items) ... [Simplified for brevity, logic matches previous]
            for(let b=bullets.length-1; b>=0; b--) {
                bullets[b].y-=15; if(bullets[b].y<0){bullets.splice(b,1);continue;}
                for(let o=obstacles.length-1; o>=0; o--) {
                    if(Math.hypot(bullets[b].x-obstacles[o].x, bullets[b].y-obstacles[o].y) < obstacles[o].size) {
                        obstacles[o].hp--; bullets.splice(b,1); createExplosion(obstacles[o].x, obstacles[o].y, '#ff9800', 5);
                        if(obstacles[o].hp<=0) { createExplosion(obstacles[o].x, obstacles[o].y, '#aaa', 15); obstacles.splice(o,1); currentRunXP+=(buffs.x2.active?10:5); }
                        break;
                    }
                }
            }
            obstacles.forEach((o,i) => {
                o.y+=o.speed; o.rot+=o.rotS; if(o.y>height){obstacles.splice(i,1); return;}
                if(Math.hypot(rocket.x-o.x, rocket.y-o.y)<(20+o.size)) {
                    if(buffs.shield.active) { createExplosion(o.x,o.y,'#aaa',10); obstacles.splice(i,1); currentRunXP+=5; } else gameOver();
                }
            });
            items.forEach((it,i) => {
                it.y+=it.speed; if(it.y>height){items.splice(i,1);return;}
                if(Math.hypot(rocket.x-it.x, rocket.y-it.y)<35) {
                    let gain=10; if(it.type=='shield'){activateBuff('shield');gain=50;} else if(it.type=='ammo'){activateBuff('ammo');gain=30;} else if(it.type=='x2'){activateBuff('x2');gain=20;} else if(it.type=='gem')gain=50;
                    currentRunXP+=(buffs.x2.active?gain*2:gain); createExplosion(it.x,it.y,it.type=='shield'?'#00f2ff':'#00e676',10); items.splice(i,1);
                }
            });

            updateBuffs();
            document.getElementById('gameXP').innerText = Math.floor(currentRunXP);
        }

        function activateBuff(type) { buffs[type].active=true; buffs[type].timer=buffs[type].max; }
        function updateBuffs() {
            let changed=false; Object.keys(buffs).forEach(k=>{ if(buffs[k].active){ buffs[k].timer--; if(buffs[k].timer<=0)buffs[k].active=false; changed=true; } });
            if(changed || gameTime%30===0) renderEffectsHUD();
        }
        function renderEffectsHUD() {
            const hud=document.getElementById('effectsHud'); hud.innerHTML='';
            Object.keys(buffs).forEach(k=>{
                if(buffs[k].active) {
                    const b=buffs[k], pct=Math.floor((b.timer/b.max)*100);
                    hud.innerHTML += `<div class="effect-badge" style="border-color:${b.color}; color:${b.color}"><div style="width:20px;height:20px;border-radius:50%;background:conic-gradient(${b.color} ${pct}%, transparent 0);display:flex;justify-content:center;align-items:center;border:1px solid rgba(255,255,255,0.3)"><div style="width:16px;height:16px;background:#000;border-radius:50%"></div></div> ${Math.ceil(b.timer/60)}s</div>`;
                }
            });
        }
        function createExplosion(x,y,c,n){ for(let i=0;i<n;i++)particles.push({x:x,y:y,vx:(Math.random()-0.5)*8,vy:(Math.random()-0.5)*8,life:30,color:c}); }

        function drawRocketGame() {
            ctx.fillStyle = '#050508'; ctx.fillRect(0,0,width,height);
            ctx.fillStyle = 'rgba(255,255,255,0.7)'; stars.forEach(s=>{ s.y+=s.z*(speedFactor*3); if(s.y>height)s.y=0; ctx.beginPath();ctx.arc(s.x,s.y,s.z,0,Math.PI*2);ctx.fill(); });
            particles.forEach((p,i)=>{ p.x+=p.vx; p.y+=p.vy; p.life--; ctx.fillStyle=p.color; ctx.globalAlpha=p.life/30; ctx.beginPath();ctx.arc(p.x,p.y,3,0,Math.PI*2);ctx.fill(); if(p.life<=0)particles.splice(i,1); }); ctx.globalAlpha=1;
            ctx.fillStyle='#ff3d00'; bullets.forEach(b=>{ ctx.beginPath();ctx.arc(b.x,b.y,4,0,Math.PI*2);ctx.fill(); });

            ctx.save(); ctx.translate(rocket.x, rocket.y);
            if(buffs.shield.active) { ctx.beginPath();ctx.arc(0,0,45,0,Math.PI*2);ctx.strokeStyle='rgba(0,242,255,0.8)';ctx.lineWidth=3;ctx.stroke();ctx.fillStyle='rgba(0,242,255,0.1)';ctx.fill(); }
            ctx.fillStyle=`rgba(0,242,255,0.8)`; ctx.beginPath();ctx.moveTo(-8,20);ctx.lineTo(0,35+Math.random()*10);ctx.lineTo(8,20);ctx.fill();
            ctx.fillStyle='#e0e0e0'; ctx.beginPath();ctx.moveTo(0,-25);ctx.lineTo(12,10);ctx.lineTo(8,20);ctx.lineTo(-8,20);ctx.lineTo(-12,10);ctx.fill();
            ctx.fillStyle='#111'; ctx.beginPath();ctx.arc(0,-5,5,0,Math.PI*2);ctx.fill();
            ctx.fillStyle='#ff3d00'; ctx.beginPath();ctx.moveTo(-12,10);ctx.lineTo(-22,25);ctx.lineTo(-10,20);ctx.fill(); ctx.beginPath();ctx.moveTo(12,10);ctx.lineTo(22,25);ctx.lineTo(10,20);ctx.fill();
            ctx.restore();

            ctx.fillStyle='#555'; obstacles.forEach(o=>{ ctx.save();ctx.translate(o.x,o.y);ctx.rotate(o.rot); ctx.beginPath(); o.verts.forEach((v,i)=>i===0?ctx.moveTo(v.x,v.y):ctx.lineTo(v.x,v.y)); ctx.closePath();ctx.fill(); ctx.strokeStyle='#8d6e63';ctx.lineWidth=2;ctx.stroke(); ctx.restore(); });
            items.forEach(it=>{ ctx.save();ctx.translate(it.x,it.y); const c=it.type=='shield'?'#00f2ff':(it.type=='gem'?'#d500f9':'#00e676'); ctx.shadowBlur=15;ctx.shadowColor=c;ctx.fillStyle=c; ctx.beginPath();ctx.arc(0,0,12,0,Math.PI*2);ctx.fill(); ctx.fillStyle='#fff';ctx.font="900 14px Arial";ctx.textAlign="center";ctx.textBaseline="middle";ctx.shadowBlur=0; ctx.fillText(it.type=='shield'?'S':(it.type=='gem'?'ðŸ’Ž':it.type=='x2'?'2X':'âš¡'),0,1); ctx.restore(); });
        }
    </script>
</body>
</html>