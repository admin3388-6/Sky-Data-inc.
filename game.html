<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Arcade Zone</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;500;700;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        /* --- Global Styles --- */
        :root { --bg-dark: #0a0a12; --glass: rgba(255, 255, 255, 0.03); --border: rgba(255, 255, 255, 0.08); --primary: #4e54c8; --accent: #00d2ff; --text: #ffffff; --text-muted: #8b9bb4; }
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Outfit', sans-serif; user-select: none; }
        body { background-color: var(--bg-dark); color: var(--text); overflow-x: hidden; }
        #canvas-bg { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: -1; opacity: 0.5; }

        /* Header */
        .header { display: flex; justify-content: space-between; align-items: center; padding: 20px 30px; background: rgba(10, 10, 18, 0.9); backdrop-filter: blur(10px); border-bottom: 1px solid var(--border); position: fixed; top: 0; width: 100%; z-index: 100; }
        .user-info { display: flex; align-items: center; gap: 15px; }
        .user-avatar { width: 40px; height: 40px; background: var(--primary); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold; color: white; }
        .xp-display { background: rgba(0, 210, 255, 0.1); color: var(--accent); padding: 5px 15px; border-radius: 20px; font-weight: bold; border: 1px solid rgba(0, 210, 255, 0.2); font-size: 14px; }

        /* Game Selection */
        .main-content { margin-top: 100px; padding: 20px; display: flex; flex-direction: column; align-items: center; gap: 30px; }
        .game-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 25px; width: 100%; max-width: 900px; }
        .game-card { background: var(--glass); border: 1px solid var(--border); padding: 30px; border-radius: 24px; text-align: center; transition: 0.3s; cursor: pointer; position: relative; overflow: hidden; }
        .game-card:hover { transform: translateY(-10px); border-color: var(--accent); box-shadow: 0 10px 30px rgba(0, 210, 255, 0.1); }
        .game-icon { font-size: 50px; color: var(--accent); margin-bottom: 20px; }
        .game-card h3 { font-size: 1.5rem; margin-bottom: 10px; }
        .game-card p { color: var(--text-muted); font-size: 0.9rem; }
        .play-btn { margin-top: 20px; padding: 10px 30px; background: var(--primary); color: white; border: none; border-radius: 50px; font-weight: bold; cursor: pointer; }

        /* Game Modal */
        .game-modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #000; z-index: 2000; display: none; flex-direction: column; }
        .game-hud { position: absolute; top: 20px; left: 20px; color: white; font-family: monospace; z-index: 2002; pointer-events: none; }
        .game-hud div { margin-bottom: 5px; text-shadow: 0 2px 4px rgba(0,0,0,0.8); font-size: 18px; }
        .close-game { position: absolute; top: 20px; right: 20px; background: rgba(255,0,0,0.3); color: white; border: 1px solid red; padding: 10px 20px; border-radius: 10px; cursor: pointer; z-index: 2002; }
        
        canvas#gameCanvas { width: 100%; height: 100%; display: block; touch-action: none; cursor: crosshair; }

        /* Game Over */
        .game-over-screen { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); z-index: 2003; display: none; flex-direction: column; justify-content: center; align-items: center; text-align: center; backdrop-filter: blur(10px); }
        .game-over-screen h1 { font-size: 3rem; color: #ff4b4b; margin-bottom: 10px; text-transform: uppercase; letter-spacing: 5px; }
        .score-result { font-size: 1.5rem; color: white; margin-bottom: 30px; }
        .xp-gained { font-size: 1.2rem; color: var(--accent); margin-bottom: 40px; }
        .action-btn { padding: 15px 40px; font-size: 18px; border-radius: 50px; border: none; cursor: pointer; margin: 10px; font-weight: bold; transition: 0.3s; }
        .btn-save { background: #00c853; color: white; box-shadow: 0 0 20px rgba(0, 200, 83, 0.4); }
        .btn-retry { background: transparent; border: 2px solid white; color: white; }
        .btn-save:hover { transform: scale(1.05); }

        @media (max-width: 600px) {
            .header { padding: 15px; }
            .xp-display { display: none; }
        }
    </style>
</head>
<body>

    <canvas id="canvas-bg"></canvas>

    <div class="header">
        <div style="font-size: 24px; font-weight: bold; color: white;">ARCADE <span style="color:var(--accent)">ZONE</span></div>
        <div class="user-info">
            <div class="xp-display"><i class="fas fa-bolt"></i> <span id="headerXp">0</span> XP</div>
            <div class="user-avatar" id="userAvatar">U</div>
            <div style="font-weight:bold" id="userName">User</div>
        </div>
    </div>

    <div class="main-content">
        <h1 style="margin-bottom:20px;">Mission Control</h1>
        
        <div class="game-grid">
            <div class="game-card" onclick="startGame('rocket')">
                <div class="game-icon"><i class="fas fa-rocket"></i></div>
                <h3>Space Dodge</h3>
                <p>Navigate the asteroid field. Survive and collect dark matter.</p>
                <div style="margin-top:15px; font-size:12px; color:var(--accent);">High Score: <span id="rocketHigh">0</span></div>
                <button class="play-btn">Launch</button>
            </div>

            <div class="game-card" onclick="startGame('snake')">
                <div class="game-icon"><i class="fas fa-worm"></i></div>
                <h3>Neon Snake</h3>
                <p>Classic snake game. Consume energy to grow.</p>
                <div style="margin-top:15px; font-size:12px; color:var(--accent);">High Score: <span id="snakeHigh">0</span></div>
                <button class="play-btn">Start</button>
            </div>
        </div>
        
        <button onclick="window.location.href='index.html'" style="margin-top:30px; background:transparent; border:1px solid #555; color:#888; padding:10px 20px; border-radius:20px; cursor:pointer;">Back to Home</button>
    </div>

    <div class="game-modal" id="gameModal">
        <div class="game-hud">
            <div>üöÄ SCORE: <span id="gameScore" style="color:#00e676">0</span></div>
            <div>‚ö° XP: <span id="gameXP" style="color:var(--accent)">0</span></div>
            <div id="shieldStatus" style="color:gold; display:none;">üõ°Ô∏è SHIELD ACTIVE!</div>
        </div>
        <button class="close-game" onclick="exitGame()">ABORT</button>
        <canvas id="gameCanvas"></canvas>

        <div id="startOverlay" style="position:absolute; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.8); display:flex; flex-direction:column; justify-content:center; align-items:center; color:white; z-index:2001; cursor:pointer;" onclick="initGameLogic()">
            <i class="fas fa-hand-pointer" style="font-size:50px; margin-bottom:20px; animation: pulse 1s infinite;"></i>
            <div style="font-size:24px; font-weight:bold;">TAP TO START</div>
            <div style="font-size:14px; color:#aaa; margin-top:10px;">Drag to Move ‚Ä¢ Dodge Meteors</div>
        </div>

        <div class="game-over-screen" id="gameOverScreen">
            <h1>MISSION FAILED</h1>
            <div class="score-result">Final Score: <span id="finalScore">0</span></div>
            <div class="xp-gained">+<span id="finalXP">0</span> XP</div>
            <div>
                <button class="action-btn btn-save" onclick="saveAndExit()">SAVE RECORD</button>
                <button class="action-btn btn-retry" onclick="resetGame()">RETRY</button>
            </div>
        </div>
    </div>

    <script type="module" src="./system.js"></script>

    <script type="module">
        import { supabase } from './supabase.js';

        // --- Global Variables ---
        let currentUser = null;
        let currentGame = null;
        let gameActive = false;
        let gameLoopId = null;
        let currentXP = 0;
        let sessionScore = 0;
        
        // --- Setup ---
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        let width, height;

        function resizeGame() {
            width = canvas.width = window.innerWidth;
            height = canvas.height = window.innerHeight;
        }
        window.addEventListener('resize', resizeGame);

        async function initPage() {
            const { data: { session } } = await supabase.auth.getSession();
            if (!session) { window.location.replace("login.html"); return; }
            currentUser = session.user;
            
            let { data: profile } = await supabase.from('users').select('*').eq('id', currentUser.id).single();
            
            document.getElementById('userName').innerText = profile?.name || "Player";
            document.getElementById('headerXp').innerText = (profile?.xp || 0).toLocaleString();
            document.getElementById('userAvatar').innerText = (profile?.name || "U").charAt(0).toUpperCase();
            
            document.getElementById('rocketHigh').innerText = localStorage.getItem('rocket_high') || 0;
            document.getElementById('snakeHigh').innerText = localStorage.getItem('snake_high') || 0;
        }
        initPage();

        // --- Game Flow ---
        window.startGame = function(type) {
            currentGame = type;
            document.getElementById('gameModal').style.display = 'flex';
            document.getElementById('startOverlay').style.display = 'flex';
            document.getElementById('gameOverScreen').style.display = 'none';
            resizeGame();
        };

        window.initGameLogic = function() {
            document.getElementById('startOverlay').style.display = 'none';
            gameActive = true;
            currentXP = 0;
            sessionScore = 0;
            if (currentGame === 'rocket') startRocketGame();
            else if (currentGame === 'snake') startSnakeGame();
        };

        window.exitGame = function() {
            gameActive = false;
            cancelAnimationFrame(gameLoopId);
            document.getElementById('gameModal').style.display = 'none';
            location.reload();
        };

        window.saveAndExit = async function() {
            const btn = document.querySelector('.btn-save');
            btn.innerText = "Syncing...";
            try {
                let { data: profile } = await supabase.from('users').select('xp').eq('id', currentUser.id).single();
                let newTotal = (profile?.xp || 0) + currentXP;
                const { error } = await supabase.from('users').update({ xp: newTotal }).eq('id', currentUser.id);
                if (error) throw error;

                const key = currentGame + '_high';
                const oldHigh = parseInt(localStorage.getItem(key) || 0);
                if (sessionScore > oldHigh) localStorage.setItem(key, sessionScore);

                window.location.href = "menu.html";
            } catch (err) {
                console.error(err);
                btn.innerText = "Retry Save";
            }
        };

        window.resetGame = function() {
            document.getElementById('gameOverScreen').style.display = 'none';
            initGameLogic();
        };

        function gameOver() {
            gameActive = false;
            cancelAnimationFrame(gameLoopId);
            document.getElementById('finalScore').innerText = Math.floor(sessionScore);
            document.getElementById('finalXP').innerText = Math.floor(currentXP);
            document.getElementById('gameOverScreen').style.display = 'flex';
        }

        // ==========================================
        // üöÄ SPACE DODGE: PROFESSIONAL EDITION
        // ==========================================
        let rocket = { x: 0, y: 0, w: 40, h: 60 };
        let obstacles = [];
        let stars = [];
        let items = []; // Fuels/Powerups
        let gameTime = 0;
        let shieldActive = false;
        let shieldTimer = 0;
        let speedFactor = 1;
        let mouse = { x: width/2, y: height/2 };

        // Mouse/Touch Tracking
        function updateInput(x, y) {
            mouse.x = x; mouse.y = y;
        }
        canvas.addEventListener('mousemove', e => updateInput(e.clientX, e.clientY));
        canvas.addEventListener('touchmove', e => { 
            e.preventDefault(); 
            updateInput(e.touches[0].clientX, e.touches[0].clientY);
        }, {passive: false});

        function startRocketGame() {
            rocket.x = width/2; rocket.y = height - 150;
            obstacles = []; items = []; stars = [];
            
            // Create Starfield
            for(let i=0; i<100; i++) stars.push({
                x: Math.random()*width, 
                y: Math.random()*height, 
                size: Math.random()*2, 
                speed: Math.random()*5 + 2
            });

            gameTime = 0; speedFactor = 1; shieldActive = false;
            mouse = { x: width/2, y: height - 150 }; // Reset position

            function loop() {
                if(!gameActive) return;
                updateSpaceLogic();
                drawSpaceGraphics();
                gameLoopId = requestAnimationFrame(loop);
            }
            loop();
        }

        function updateSpaceLogic() {
            gameTime++;
            
            // 1. Difficulty Scaling
            if (gameTime % 300 === 0) speedFactor += 0.1; // Slowly increase speed
            const currentSpeed = (3 + (gameTime/600)) * speedFactor;

            // 2. Rocket Movement (Smooth Lerp)
            rocket.x += (mouse.x - rocket.x) * 0.15; // Faster response
            rocket.y += (mouse.y - rocket.y) * 0.15;

            // 3. Update Stars (Warp Effect)
            stars.forEach(s => {
                s.y += s.speed * speedFactor;
                if(s.y > height) { s.y = 0; s.x = Math.random()*width; }
            });

            // 4. Spawn Obstacles (Smart Spawning - No Overlap)
            if (gameTime % Math.max(20, Math.floor(60/speedFactor)) === 0) {
                const size = Math.random() * 40 + 30; // 30-70px
                const xPos = Math.random() * (width - size);
                
                // Check overlap with last 3 obstacles
                let overlap = false;
                for(let j=obstacles.length-1; j>=Math.max(0, obstacles.length-3); j--) {
                    if(Math.abs(obstacles[j].x - xPos) < size + 10) overlap = true;
                }

                if(!overlap) {
                    obstacles.push({
                        x: xPos, y: -100, size: size,
                        speed: currentSpeed + Math.random(),
                        rotation: 0, rotSpeed: (Math.random()-0.5) * 0.1,
                        type: 'meteor'
                    });
                }
            }

            // 5. Spawn Items (Rare)
            if (gameTime % 180 === 0) {
                const rand = Math.random() * 100;
                let type = 'fuel'; // ‚õΩ
                if (rand < 2) type = 'shield'; // üõ°Ô∏è Rainbow (1%)
                else if (rand < 10) type = 'gem'; // üíé Rare (8%)
                
                items.push({
                    x: Math.random() * (width - 30), y: -50, size: 30,
                    type: type, speed: currentSpeed
                });
            }

            // 6. Shield Logic
            if(shieldActive) {
                shieldTimer--;
                document.getElementById('shieldStatus').style.display = 'block';
                if(shieldTimer <= 0) { shieldActive = false; document.getElementById('shieldStatus').style.display = 'none'; }
            }

            // 7. Scoring
            sessionScore = Math.floor(gameTime / 10);
            document.getElementById('gameScore').innerText = sessionScore;
            document.getElementById('gameXP').innerText = Math.floor(currentXP);

            // 8. Collision Loop
            // Obstacles
            for (let i = obstacles.length - 1; i >= 0; i--) {
                let o = obstacles[i];
                o.y += o.speed;
                o.rotation += o.rotSpeed;
                if (o.y > height) { obstacles.splice(i, 1); currentXP += 1; continue; } // Bonus for dodge

                if (!shieldActive && getDistance(rocket.x, rocket.y, o.x + o.size/2, o.y + o.size/2) < (rocket.w/2 + o.size/3)) {
                    gameOver();
                }
            }
            // Items
            for (let i = items.length - 1; i >= 0; i--) {
                let it = items[i];
                it.y += it.speed;
                if(it.y > height) { items.splice(i, 1); continue; }

                if (getDistance(rocket.x, rocket.y, it.x + 15, it.y + 15) < 40) {
                    if(it.type === 'shield') { shieldActive = true; shieldTimer = 900; currentXP += 100; }
                    else if(it.type === 'gem') currentXP += 50;
                    else currentXP += 10;
                    items.splice(i, 1);
                }
            }
        }

        function drawSpaceGraphics() {
            ctx.clearRect(0, 0, width, height);

            // 1. Draw Stars
            ctx.fillStyle = 'white';
            stars.forEach(s => {
                ctx.globalAlpha = Math.random() * 0.5 + 0.3;
                ctx.beginPath(); ctx.arc(s.x, s.y, s.size, 0, Math.PI*2); ctx.fill();
            });
            ctx.globalAlpha = 1;

            // 2. Draw Obstacles (Meteors ü™®)
            ctx.font = "40px Arial";
            ctx.textAlign = "center";
            ctx.textBaseline = "middle";
            
            obstacles.forEach(o => {
                ctx.save();
                ctx.translate(o.x + o.size/2, o.y + o.size/2);
                ctx.rotate(o.rotation);
                ctx.font = `${o.size}px Arial`;
                ctx.fillText("ü™®", 0, 0);
                ctx.restore();
            });

            // 3. Draw Items
            items.forEach(it => {
                let icon = "‚õΩ";
                if(it.type === 'shield') icon = "üõ°Ô∏è";
                if(it.type === 'gem') icon = "üíé";
                
                // Pulsing effect
                const scale = 1 + Math.sin(gameTime * 0.1) * 0.1;
                ctx.save();
                ctx.translate(it.x + 15, it.y + 15);
                ctx.scale(scale, scale);
                ctx.font = "30px Arial";
                ctx.fillText(icon, 0, 0);
                ctx.restore();
            });

            // 4. Draw Rocket üöÄ
            ctx.save();
            ctx.translate(rocket.x, rocket.y);
            
            // Shield Effect
            if(shieldActive) {
                ctx.beginPath();
                ctx.arc(0, 0, 40, 0, Math.PI*2);
                ctx.fillStyle = `hsla(${gameTime * 5 % 360}, 100%, 50%, 0.3)`;
                ctx.fill();
                ctx.strokeStyle = `hsla(${gameTime * 5 % 360}, 100%, 50%, 0.8)`;
                ctx.lineWidth = 3;
                ctx.stroke();
            }

            // Engine Flame
            ctx.fillStyle = (gameTime % 4 === 0) ? "orange" : "red";
            ctx.beginPath();
            ctx.moveTo(-10, 25);
            ctx.lineTo(0, 45 + Math.random()*10);
            ctx.lineTo(10, 25);
            ctx.fill();

            // The Rocket Emoji
            ctx.font = "50px Arial";
            ctx.fillText("üöÄ", 0, 0);
            ctx.restore();
        }

        function getDistance(x1, y1, x2, y2) {
            const xDist = x2 - x1;
            const yDist = y2 - y1;
            return Math.sqrt(xDist * xDist + yDist * yDist);
        }

        // ==========================================
        // üêç SNAKE GAME (No Changes needed, works fine)
        // ==========================================
        const gridSize = 20;
        let snake = []; let food = {};
        let direction = 'RIGHT'; let nextDirection = 'RIGHT';
        let snakeSpeed = 10; let snakeFrame = 0;

        document.addEventListener('keydown', e => {
            if (e.key === 'ArrowUp' && direction !== 'DOWN') nextDirection = 'UP';
            else if (e.key === 'ArrowDown' && direction !== 'UP') nextDirection = 'DOWN';
            else if (e.key === 'ArrowLeft' && direction !== 'RIGHT') nextDirection = 'LEFT';
            else if (e.key === 'ArrowRight' && direction !== 'LEFT') nextDirection = 'RIGHT';
        });

        let touchStartX = 0; let touchStartY = 0;
        canvas.addEventListener('touchstart', e => { touchStartX = e.touches[0].clientX; touchStartY = e.touches[0].clientY; }, {passive: false});
        canvas.addEventListener('touchend', e => {
            let dx = e.changedTouches[0].clientX - touchStartX;
            let dy = e.changedTouches[0].clientY - touchStartY;
            if (Math.abs(dx) > Math.abs(dy)) { if (dx > 0 && direction !== 'LEFT') nextDirection = 'RIGHT'; else if (dx < 0 && direction !== 'RIGHT') nextDirection = 'LEFT'; } 
            else { if (dy > 0 && direction !== 'UP') nextDirection = 'DOWN'; else if (dy < 0 && direction !== 'DOWN') nextDirection = 'UP'; }
        });

        function startSnakeGame() {
            snake = [{x: 10, y: 10}, {x: 9, y: 10}, {x: 8, y: 10}];
            placeFood(); direction = 'RIGHT'; nextDirection = 'RIGHT'; snakeSpeed = 10;
            function loop() {
                if(!gameActive) return;
                snakeFrame++;
                if (snakeFrame >= snakeSpeed) { snakeFrame = 0; updateSnake(); }
                drawSnake();
                gameLoopId = requestAnimationFrame(loop);
            }
            loop();
        }

        function placeFood() {
            food = { x: Math.floor(Math.random() * (width / gridSize)), y: Math.floor(Math.random() * (height / gridSize)) };
            for(let cell of snake) if(cell.x === food.x && cell.y === food.y) placeFood();
        }

        function updateSnake() {
            direction = nextDirection;
            const head = { ...snake[0] };
            if (direction === 'UP') head.y--; else if (direction === 'DOWN') head.y++; else if (direction === 'LEFT') head.x--; else if (direction === 'RIGHT') head.x++;
            if (head.x < 0 || head.x >= width/gridSize || head.y < 0 || head.y >= height/gridSize) { gameOver(); return; }
            for(let cell of snake) if (cell.x === head.x && cell.y === head.y) { gameOver(); return; }
            snake.unshift(head);
            if (head.x === food.x && head.y === food.y) {
                currentXP += 5; sessionScore++;
                if (sessionScore % 5 === 0 && snakeSpeed > 3) snakeSpeed--;
                placeFood();
            } else snake.pop();
            document.getElementById('gameScore').innerText = sessionScore;
            document.getElementById('gameXP').innerText = currentXP;
        }

        function drawSnake() {
            ctx.fillStyle = '#0a0a12'; ctx.fillRect(0, 0, width, height);
            // Draw Grid
            ctx.strokeStyle = 'rgba(255,255,255,0.05)'; ctx.lineWidth = 1;
            for(let i=0; i<width; i+=gridSize) { ctx.beginPath(); ctx.moveTo(i,0); ctx.lineTo(i,height); ctx.stroke(); }
            for(let i=0; i<height; i+=gridSize) { ctx.beginPath(); ctx.moveTo(0,i); ctx.lineTo(width,i); ctx.stroke(); }

            ctx.fillStyle = '#00e676';
            snake.forEach(cell => ctx.fillRect(cell.x * gridSize + 1, cell.y * gridSize + 1, gridSize-2, gridSize-2));
            ctx.font = "20px Arial"; ctx.textAlign = "center"; ctx.textBaseline = "middle";
            ctx.fillText("üçå", food.x * gridSize + gridSize/2, food.y * gridSize + gridSize/2);
        }
    </script>
</body>
</html>