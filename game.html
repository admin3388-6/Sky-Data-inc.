<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Arcade Zone</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;500;700;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        /* --- Global Styles --- */
        :root { --bg-dark: #0a0a12; --glass: rgba(255, 255, 255, 0.03); --border: rgba(255, 255, 255, 0.08); --primary: #4e54c8; --accent: #00d2ff; --text: #ffffff; --text-muted: #8b9bb4; }
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Outfit', sans-serif; user-select: none; }
        body { background-color: var(--bg-dark); color: var(--text); overflow-x: hidden; }
        #canvas-bg { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: -1; opacity: 0.5; }

        /* Header */
        .header { display: flex; justify-content: space-between; align-items: center; padding: 20px 30px; background: rgba(10, 10, 18, 0.95); backdrop-filter: blur(10px); border-bottom: 1px solid var(--border); position: fixed; top: 0; width: 100%; z-index: 100; transition: transform 0.3s; }
        .user-info { display: flex; align-items: center; gap: 15px; }
        .xp-display { background: rgba(0, 210, 255, 0.1); color: var(--accent); padding: 5px 15px; border-radius: 20px; font-weight: bold; border: 1px solid rgba(0, 210, 255, 0.2); font-size: 14px; }

        /* Menu Content */
        .main-content { margin-top: 100px; padding: 20px; display: flex; flex-direction: column; align-items: center; gap: 30px; }
        .game-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 25px; width: 100%; max-width: 900px; }
        .game-card { background: var(--glass); border: 1px solid var(--border); padding: 30px; border-radius: 24px; text-align: center; transition: 0.3s; cursor: pointer; position: relative; overflow: hidden; }
        .game-card:hover { transform: translateY(-10px); border-color: var(--accent); box-shadow: 0 10px 30px rgba(0, 210, 255, 0.1); }
        .game-icon { font-size: 50px; color: var(--accent); margin-bottom: 20px; }
        .play-btn { margin-top: 20px; padding: 10px 30px; background: var(--primary); color: white; border: none; border-radius: 50px; font-weight: bold; cursor: pointer; }

        /* --- Full Screen Game Mode --- */
        .game-modal { 
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
            background: #0b0b14; /* ŸÑŸàŸÜ ŸÅÿ∂ÿßÿ° ÿπŸÖŸäŸÇ */
            z-index: 200000; /* ŸÅŸàŸÇ ŸÉŸÑ ÿ¥Ÿäÿ° */
            display: none; flex-direction: column; 
        }
        
        /* Game UI (HUD) */
        .game-hud { 
            position: absolute; top: 20px; left: 20px; 
            color: white; font-family: 'Courier New', monospace; 
            z-index: 200002; pointer-events: none; 
            text-shadow: 0 2px 4px black;
        }
        .hud-item { font-size: 20px; font-weight: bold; margin-bottom: 5px; }
        
        .close-game { 
            position: absolute; top: 20px; right: 20px; 
            background: rgba(255, 0, 0, 0.2); color: #ff8888; 
            border: 1px solid #ff4444; padding: 8px 20px; 
            border-radius: 8px; cursor: pointer; z-index: 200002; 
            font-weight: bold; backdrop-filter: blur(5px);
        }

        canvas#gameCanvas { width: 100%; height: 100%; display: block; cursor: crosshair; }

        /* Overlays */
        #startOverlay, #gameOverScreen {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.85); z-index: 200003;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            backdrop-filter: blur(8px);
        }
        
        .game-over-title { font-size: 3rem; color: #ff4b4b; margin-bottom: 10px; font-weight: 900; letter-spacing: 2px; }
        .action-btn { padding: 15px 40px; font-size: 18px; border-radius: 50px; border: none; cursor: pointer; margin: 10px; font-weight: bold; transition: 0.3s; min-width: 200px; }
        .btn-save { background: linear-gradient(135deg, #00c853, #009624); color: white; box-shadow: 0 0 20px rgba(0, 200, 83, 0.4); }
        .btn-retry { background: transparent; border: 2px solid white; color: white; }

        @media (max-width: 600px) { .header { padding: 15px; } .xp-display { display: none; } }
    </style>
</head>
<body>

    <canvas id="canvas-bg"></canvas>

    <div class="header" id="mainHeader">
        <div style="font-size: 24px; font-weight: bold; color: white;">SKY <span style="color:var(--accent)">ARCADE</span></div>
        <div class="user-info">
            <div class="xp-display"><i class="fas fa-bolt"></i> <span id="headerXp">0</span></div>
            <div id="userName" style="font-weight:bold">User</div>
        </div>
    </div>

    <div class="main-content" id="mainMenu">
        <div class="game-grid">
            <div class="game-card" onclick="startGame('rocket')">
                <div class="game-icon"><i class="fas fa-rocket"></i></div>
                <h3>Space Dodge</h3>
                <p>Avoid meteors. Collect energy cores.</p>
                <div style="margin-top:10px; font-size:12px; color:#aaa;">Best: <span id="rocketHigh">0</span></div>
                <button class="play-btn">Launch</button>
            </div>
            <div class="game-card" onclick="startGame('snake')">
                <div class="game-icon"><i class="fas fa-dragon"></i></div>
                <h3>Neon Snake</h3>
                <p>Grow your cyber-snake.</p>
                <div style="margin-top:10px; font-size:12px; color:#aaa;">Best: <span id="snakeHigh">0</span></div>
                <button class="play-btn">Start</button>
            </div>
        </div>
        <button onclick="window.location.href='menu.html'" style="margin-top:30px; background:transparent; border:1px solid #555; color:#888; padding:10px 20px; border-radius:20px; cursor:pointer;">Back to Dashboard</button>
    </div>

    <div class="game-modal" id="gameModal">
        <div class="game-hud">
            <div class="hud-item">üöÄ <span id="gameScore">0</span></div>
            <div class="hud-item" style="color:var(--accent)">‚ö° <span id="gameXP">0</span></div>
            <div id="shieldStatus" style="color:#00f2ff; display:none; font-size:16px;">üõ°Ô∏è SHIELD: <span id="shieldTime">0</span>s</div>
        </div>
        <button class="close-game" onclick="exitGame()">EXIT</button>
        
        <canvas id="gameCanvas"></canvas>

        <div id="startOverlay" onclick="initGameLogic()">
            <i class="fas fa-hand-pointer" style="font-size:50px; color:white; margin-bottom:20px; animation: pulse 1s infinite;"></i>
            <h2 style="color:white;">TAP TO START</h2>
            <p style="color:#aaa;">Drag to move ‚Ä¢ Avoid Rocks</p>
        </div>

        <div id="gameOverScreen" style="display:none;">
            <h1 class="game-over-title">CRASHED!</h1>
            <div style="color:white; font-size:20px; margin-bottom:10px;">Score: <span id="finalScore">0</span></div>
            <div style="color:var(--accent); font-size:18px; margin-bottom:30px;">XP Earned: +<span id="finalXP">0</span></div>
            
            <button class="action-btn btn-save" onclick="saveAndExit()">SAVE XP</button>
            <button class="action-btn btn-retry" onclick="resetGame()">RETRY</button>
        </div>
    </div>

    <script type="module" src="./system.js"></script>

    <script type="module">
        import { supabase } from './supabase.js';

        // Variables
        let currentUser = null;
        let currentGame = null;
        let gameActive = false;
        let gameLoopId = null;
        let currentRunXP = 0;
        let currentRunScore = 0;
        
        // Canvas
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        let width, height;

        function resizeGame() { width = canvas.width = window.innerWidth; height = canvas.height = window.innerHeight; }
        window.addEventListener('resize', resizeGame);

        // Init
        async function initPage() {
            const { data: { session } } = await supabase.auth.getSession();
            if (!session) { window.location.replace("login.html"); return; }
            currentUser = session.user;
            
            let { data: profile } = await supabase.from('users').select('*').eq('id', currentUser.id).single();
            document.getElementById('userName').innerText = profile?.name || "Player";
            document.getElementById('headerXp').innerText = (profile?.xp || 0).toLocaleString();
            
            document.getElementById('rocketHigh').innerText = localStorage.getItem('rocket_high') || 0;
            document.getElementById('snakeHigh').innerText = localStorage.getItem('snake_high') || 0;
        }
        initPage();

        // Game State Management
        window.startGame = function(type) {
            currentGame = type;
            document.getElementById('gameModal').style.display = 'flex';
            document.getElementById('startOverlay').style.display = 'flex';
            document.getElementById('gameOverScreen').style.display = 'none';
            resizeGame();
            
            // Hide System UI (Buttons)
            const sysUI = document.querySelectorAll('.system-controls, .support-float');
            sysUI.forEach(el => el.style.display = 'none');
        };

        window.initGameLogic = function() {
            document.getElementById('startOverlay').style.display = 'none';
            gameActive = true;
            currentRunXP = 0;
            currentRunScore = 0;
            if (currentGame === 'rocket') startRocketGame();
            else if (currentGame === 'snake') startSnakeGame();
        };

        window.exitGame = function() {
            gameActive = false;
            cancelAnimationFrame(gameLoopId);
            document.getElementById('gameModal').style.display = 'none';
            // Show System UI
            const sysUI = document.querySelectorAll('.system-controls, .support-float');
            sysUI.forEach(el => el.style.display = 'flex');
            // Reload to clear canvas state completely
            location.reload();
        };

        window.saveAndExit = async function() {
            const btn = document.querySelector('.btn-save');
            btn.innerText = "Saving...";
            try {
                let { data: profile } = await supabase.from('users').select('xp').eq('id', currentUser.id).single();
                let newTotal = (profile?.xp || 0) + currentRunXP;
                const { error } = await supabase.from('users').update({ xp: newTotal }).eq('id', currentUser.id);
                if (error) throw error;

                // Save High Score
                const key = currentGame + '_high';
                const oldHigh = parseInt(localStorage.getItem(key) || 0);
                if (currentRunScore > oldHigh) localStorage.setItem(key, currentRunScore);

                window.location.href = "menu.html";
            } catch (err) {
                console.error(err);
                btn.innerText = "Error! Retry";
            }
        };

        window.resetGame = function() {
            // Save local points before retry
            let vault = parseInt(localStorage.getItem('skydata_unsaved_xp') || 0);
            localStorage.setItem('skydata_unsaved_xp', vault + currentRunXP);
            
            document.getElementById('gameOverScreen').style.display = 'none';
            initGameLogic();
        };

        function gameOver() {
            gameActive = false;
            cancelAnimationFrame(gameLoopId);
            document.getElementById('finalScore').innerText = Math.floor(currentRunScore);
            document.getElementById('finalXP').innerText = Math.floor(currentRunXP);
            document.getElementById('gameOverScreen').style.display = 'flex';
        }

        // ==========================================
        // üöÄ ROCKET GAME ENGINE (CUSTOM DRAWING)
        // ==========================================
        let rocket = { x: 0, y: 0 };
        let obstacles = [];
        let items = [];
        let stars = [];
        let gameTime = 0;
        let shieldActive = false;
        let shieldTimer = 0;
        let speedFactor = 1;
        let mouse = { x: width/2, y: height/2 };

        // Input Handler (Fixed Glitch)
        function updateInput(clientX, clientY) {
            // Get canvas position to fix offset issues
            const rect = canvas.getBoundingClientRect();
            mouse.x = clientX - rect.left;
            mouse.y = clientY - rect.top;
        }
        canvas.addEventListener('mousemove', e => updateInput(e.clientX, e.clientY));
        canvas.addEventListener('touchmove', e => { 
            e.preventDefault(); 
            updateInput(e.touches[0].clientX, e.touches[0].clientY);
        }, {passive: false});

        function startRocketGame() {
            rocket.x = width/2; rocket.y = height - 150;
            mouse.x = width/2; mouse.y = height - 150;
            obstacles = []; items = []; stars = [];
            
            // Warp Speed Stars
            for(let i=0; i<80; i++) stars.push({x: Math.random()*width, y: Math.random()*height, speed: Math.random()*10+5});

            gameTime = 0; speedFactor = 1; shieldActive = false;
            
            function loop() {
                if(!gameActive) return;
                updateRocket();
                drawRocketGame();
                gameLoopId = requestAnimationFrame(loop);
            }
            loop();
        }

        function updateRocket() {
            gameTime++;
            if (gameTime % 300 === 0) speedFactor += 0.15;
            const currentSpeed = (3 + (gameTime/500)) * speedFactor;

            // Rocket Physics (Smooth)
            rocket.x += (mouse.x - rocket.x) * 0.15;
            rocket.y += (mouse.y - rocket.y) * 0.15;

            // Spawn Meteors (Polygons)
            if (gameTime % Math.max(15, Math.floor(50/speedFactor)) === 0) {
                const size = Math.random() * 30 + 20;
                obstacles.push({
                    x: Math.random() * width, y: -50, size: size,
                    speed: currentSpeed, vertices: createAsteroidVertices(size),
                    rot: 0, rotSpeed: (Math.random()-0.5)*0.1
                });
            }

            // Spawn Energy
            if (gameTime % 200 === 0) {
                const r = Math.random();
                let type = 'fuel'; 
                if (r < 0.05) type = 'shield'; 
                items.push({ x: Math.random()*(width-40), y: -50, type: type, speed: currentSpeed });
            }

            // Logic Loop
            obstacles.forEach((o, i) => {
                o.y += o.speed; o.rot += o.rotSpeed;
                if(o.y > height) { obstacles.splice(i, 1); currentRunXP++; return; }
                
                // Collision
                const dx = rocket.x - o.x; const dy = rocket.y - o.y;
                if (Math.sqrt(dx*dx + dy*dy) < (20 + o.size)) {
                    if (shieldActive) { obstacles.splice(i, 1); currentRunXP += 5; } // Smash rock
                    else gameOver();
                }
            });

            items.forEach((it, i) => {
                it.y += it.speed;
                if (Math.hypot(rocket.x - it.x, rocket.y - it.y) < 40) {
                    if(it.type === 'shield') { shieldActive = true; shieldTimer = 600; }
                    else currentRunXP += 10;
                    items.splice(i, 1);
                }
            });

            if(shieldActive) {
                shieldTimer--;
                document.getElementById('shieldStatus').style.display = 'block';
                document.getElementById('shieldTime').innerText = Math.floor(shieldTimer/60);
                if(shieldTimer<=0) { shieldActive=false; document.getElementById('shieldStatus').style.display='none'; }
            }

            currentRunScore = Math.floor(gameTime / 10);
            document.getElementById('gameScore').innerText = currentRunScore;
            document.getElementById('gameXP').innerText = Math.floor(currentRunXP);
        }

        // --- DRAWING FUNCTIONS (NO EMOJIS) ---
        
        function drawRocketGame() {
            ctx.fillStyle = '#0b0b14'; ctx.fillRect(0,0,width,height);

            // 1. Stars (Warp)
            ctx.fillStyle = 'rgba(255,255,255,0.6)';
            stars.forEach(s => {
                s.y += s.speed * speedFactor;
                if(s.y > height) s.y = 0;
                ctx.beginPath(); ctx.arc(s.x, s.y, 1.5, 0, Math.PI*2); ctx.fill();
            });

            // 2. Rocket Drawing
            ctx.save();
            ctx.translate(rocket.x, rocket.y);
            
            // Shield
            if(shieldActive) {
                ctx.beginPath(); ctx.arc(0,0, 45, 0, Math.PI*2);
                ctx.strokeStyle = `rgba(0, 242, 255, ${Math.random()*0.5 + 0.5})`; 
                ctx.lineWidth = 3; ctx.stroke();
                ctx.fillStyle = 'rgba(0, 242, 255, 0.1)'; ctx.fill();
            }

            // Engine Flame
            ctx.fillStyle = `rgba(255, ${Math.random()*150}, 0, 0.8)`;
            ctx.beginPath(); ctx.moveTo(-8, 20); ctx.lineTo(0, 40+Math.random()*15); ctx.lineTo(8, 20); ctx.fill();

            // Body
            ctx.fillStyle = '#eee';
            ctx.beginPath(); ctx.ellipse(0, 0, 12, 30, 0, 0, Math.PI*2); ctx.fill();
            // Fins
            ctx.fillStyle = '#d32f2f';
            ctx.beginPath(); ctx.moveTo(-12, 10); ctx.lineTo(-20, 30); ctx.lineTo(-10, 25); ctx.fill();
            ctx.beginPath(); ctx.moveTo(12, 10); ctx.lineTo(20, 30); ctx.lineTo(10, 25); ctx.fill();
            // Window
            ctx.fillStyle = '#00d2ff';
            ctx.beginPath(); ctx.arc(0, -10, 6, 0, Math.PI*2); ctx.fill();
            ctx.restore();

            // 3. Obstacles (Asteroids)
            ctx.fillStyle = '#555';
            obstacles.forEach(o => {
                ctx.save(); ctx.translate(o.x, o.y); ctx.rotate(o.rot);
                ctx.beginPath();
                o.vertices.forEach((v, i) => {
                    i === 0 ? ctx.moveTo(v.x, v.y) : ctx.lineTo(v.x, v.y);
                });
                ctx.closePath();
                ctx.fill();
                // Crater details
                ctx.fillStyle = 'rgba(0,0,0,0.3)'; ctx.beginPath(); ctx.arc(5, 5, o.size/4, 0, Math.PI*2); ctx.fill();
                ctx.fillStyle = '#555'; // Reset for next
                ctx.restore();
            });

            // 4. Items (Energy)
            items.forEach(it => {
                ctx.save(); ctx.translate(it.x, it.y);
                if(it.type === 'shield') {
                    ctx.fillStyle = '#00f2ff';
                    ctx.beginPath(); ctx.arc(0,0, 15, 0, Math.PI*2); ctx.fill(); // Orb
                    ctx.strokeStyle = 'white'; ctx.lineWidth=2; ctx.stroke();
                } else {
                    ctx.fillStyle = '#00e676';
                    ctx.beginPath(); ctx.rect(-10, -15, 20, 30); ctx.fill(); // Jerry can shape
                    ctx.fillStyle = '#004d40'; ctx.font="12px Arial"; ctx.fillText("‚ö°", -6, 5);
                }
                ctx.restore();
            });
        }

        // Helper: Create jagged rock shape
        function createAsteroidVertices(radius) {
            const vertices = [];
            const numPoints = 8;
            for (let i = 0; i < numPoints; i++) {
                const angle = (i / numPoints) * Math.PI * 2;
                const r = radius * (0.8 + Math.random() * 0.4); // Randomize radius
                vertices.push({ x: Math.cos(angle) * r, y: Math.sin(angle) * r });
            }
            return vertices;
        }

        // ==========================================
        // üêç SNAKE (Simple Drawing)
        // ==========================================
        let snake = []; let food = {}; let direction='RIGHT'; let nextDir='RIGHT'; let sFrame=0; const gridSize=20;
        document.addEventListener('keydown', e => {
            if(e.key=='ArrowUp'&&direction!='DOWN')nextDir='UP'; else if(e.key=='ArrowDown'&&direction!='UP')nextDir='DOWN';
            else if(e.key=='ArrowLeft'&&direction!='RIGHT')nextDir='LEFT'; else if(e.key=='ArrowRight'&&direction!='LEFT')nextDir='RIGHT';
        });
        // Touch logic needed for snake too? (Added simple swipe)
        let tsX=0, tsY=0; canvas.addEventListener('touchstart', e=>{tsX=e.touches[0].clientX;tsY=e.touches[0].clientY}, {passive:false});
        canvas.addEventListener('touchend', e=>{
            let dx=e.changedTouches[0].clientX-tsX, dy=e.changedTouches[0].clientY-tsY;
            if(Math.abs(dx)>Math.abs(dy)) { if(dx>0&&direction!='LEFT')nextDir='RIGHT'; else if(dx<0&&direction!='RIGHT')nextDir='LEFT'; }
            else { if(dy>0&&direction!='UP')nextDir='DOWN'; else if(dy<0&&direction!='DOWN')nextDir='UP'; }
        });

        function startSnakeGame() {
            snake=[{x:10,y:10},{x:9,y:10}]; placeFood(); direction='RIGHT'; nextDir='RIGHT';
            function loop(){ if(!gameActive)return; sFrame++; if(sFrame>5){sFrame=0;updateSnake()} drawSnake(); gameLoopId=requestAnimationFrame(loop); }
            loop();
        }
        function placeFood(){ food={x:Math.floor(Math.random()*(width/gridSize)),y:Math.floor(Math.random()*(height/gridSize))}; }
        function updateSnake(){
            direction=nextDir; const head={...snake[0]};
            if(direction=='UP')head.y--; if(direction=='DOWN')head.y++; if(direction=='LEFT')head.x--; if(direction=='RIGHT')head.x++;
            if(head.x<0||head.x>=width/gridSize||head.y<0||head.y>=height/gridSize){gameOver();return;}
            for(let c of snake)if(c.x==head.x&&c.y==head.y){gameOver();return;}
            snake.unshift(head);
            if(head.x==food.x&&head.y==food.y){ currentRunXP+=5; currentRunScore++; placeFood(); } else snake.pop();
            document.getElementById('gameScore').innerText=currentRunScore; document.getElementById('gameXP').innerText=currentRunXP;
        }
        function drawSnake(){
            ctx.fillStyle='#000'; ctx.fillRect(0,0,width,height);
            ctx.strokeStyle='#111'; ctx.beginPath();
            for(let i=0;i<width;i+=gridSize){ctx.moveTo(i,0);ctx.lineTo(i,height)} for(let i=0;i<height;i+=gridSize){ctx.moveTo(0,i);ctx.lineTo(width,i)} ctx.stroke();
            
            // Draw Snake (Neon Green Rects)
            ctx.fillStyle='#00e676'; ctx.shadowBlur=10; ctx.shadowColor='#00e676';
            snake.forEach(c=>ctx.fillRect(c.x*gridSize+1, c.y*gridSize+1, gridSize-2, gridSize-2));
            ctx.shadowBlur=0;

            // Draw Food (Apple)
            ctx.fillStyle='#ff1744'; ctx.beginPath(); ctx.arc(food.x*gridSize+10, food.y*gridSize+10, 8, 0, Math.PI*2); ctx.fill();
        }
    </script>
</body>
</html>